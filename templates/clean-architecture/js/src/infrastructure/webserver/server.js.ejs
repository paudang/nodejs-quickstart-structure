const express = require('express');
const cors = require('cors');
require('dotenv').config();
const logger = require('../log/logger');
const morgan = require('morgan');
<%_ if (communication === 'REST APIs') { -%>const apiRoutes = require('../../interfaces/routes/api');<%_ } -%>
<%_ if (communication === 'REST APIs') { -%>
const swaggerUi = require('swagger-ui-express');
const swaggerSpecs = require('./swagger');
<%_ } -%>
<%_ if (communication === 'GraphQL') { -%>
const { ApolloServer } = require('@apollo/server');
const { expressMiddleware } = require('@apollo/server/express4');
const { ApolloServerPluginLandingPageLocalDefault } = require('@apollo/server/plugin/landingPage/default');
const { typeDefs, resolvers } = require('../../interfaces/graphql');
const { gqlContext } = require('../../interfaces/graphql/context');
<%_ } -%>

const startServer = async (port) => {
    const app = express();

    app.use(cors());
    app.use(express.json());
    app.use(morgan('combined', { stream: { write: message => logger.info(message.trim()) } }));
    <%_ if (communication === 'REST APIs') { -%>
    app.use('/api', apiRoutes);
    <%_ } -%>
    <%_ if (communication === 'REST APIs') { -%>
    app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerSpecs));
    <%_ } -%>
    <%_ if (communication === 'GraphQL') { -%>
    // GraphQL Setup
    const server = new ApolloServer({
        typeDefs,
        resolvers,
        plugins: [ApolloServerPluginLandingPageLocalDefault({ embed: true })],
    });
    await server.start();
    app.use('/graphql', expressMiddleware(server, { context: gqlContext }));
    <%_ } -%>
    app.get('/health', (req, res) => {
        res.json({ status: 'UP' });
    });

    app.listen(port, () => {
        logger.info(`Server running on port ${port}`);
    });
};

module.exports = startServer;
