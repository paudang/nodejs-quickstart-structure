const startServer = require('./infrastructure/webserver/server');
<% if (communication === 'Kafka') { %>const { connectKafka, sendMessage } = require('./infrastructure/messaging/kafkaClient');<% } %>

const PORT = process.env.PORT || 3000;

// Database Sync
const syncDatabase = async () => {
    let retries = 30;
    while (retries) {
        try {
            const sequelize = require('./infrastructure/database/database');
            await sequelize.sync();
            console.log('Database synced');
            
            // Start the web server after DB sync
            startServer(PORT);
            
            <% if (communication === 'Kafka') { %>
            // Connect Kafka
            connectKafka().then(async () => {
              console.log('Kafka connected');
              await sendMessage('test-topic', 'Hello Kafka from Clean Arch JS!');
            }).catch(err => {
              console.error('Failed to connect to Kafka:', err);
            });
            <% } %>

            break;
        } catch (err) {
            console.error('Database sync failed:', err);
            retries -= 1;
            console.log(`Retries left: ${retries}. Waiting 5s...`);
            await new Promise(res => setTimeout(res, 5000));
        }
    }
};
syncDatabase();