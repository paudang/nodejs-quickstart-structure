const startServer = require('./infrastructure/webserver/server');
const logger = require('./infrastructure/log/logger');
<% if (communication === 'Kafka') { -%>
const { connectKafka, sendMessage } = require('./infrastructure/messaging/kafkaClient');
<% } -%>

const PORT = process.env.PORT || 3000;

<%_ if (database !== 'None') { -%>
// Database Sync
const syncDatabase = async () => {
    let retries = 30;
    while (retries) {
        try {
            <%_ if (database === 'MongoDB') { -%>
            const connectDB = require('./infrastructure/database/database');
            await connectDB();
            <%_ } else { -%>
            const sequelize = require('./infrastructure/database/database');
            await sequelize.sync();
            <%_ } -%>
            logger.info('Database synced');
            // Start the web server after DB sync
            startServer(PORT);
            <%_ if (communication === 'Kafka') { -%>
            // Connect Kafka
            connectKafka().then(async () => {
              logger.info('Kafka connected');
              await sendMessage('test-topic', 'Hello Kafka from Clean Arch JS!');
            }).catch(err => {
              logger.error('Failed to connect to Kafka:', err);
            });
            <%_ } -%>
            break;
        } catch (error) {
            logger.error('Error syncing database:', error);
            retries -= 1;
            logger.info(`Retries left: ${retries}`);
            await new Promise(res => setTimeout(res, 5000));
        }
    }
};
syncDatabase();
<%_ } else { -%>
startServer(PORT);
<%_ if (communication === 'Kafka') { -%>
// Connect Kafka
connectKafka().then(async () => {
  logger.info('Kafka connected');
  await sendMessage('test-topic', 'Hello Kafka from Clean Arch JS!');
}).catch(err => {
  logger.error('Failed to connect to Kafka:', err);
});
<%_ } -%>
<%_ } -%>