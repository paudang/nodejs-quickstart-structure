const startServer = require('./infrastructure/webserver/server');
const logger = require('./infrastructure/log/logger');
<% if (communication === 'Kafka') { -%>
const { connectKafka, sendMessage } = require('./infrastructure/messaging/kafkaClient');
<% } -%>

const PORT = process.env.PORT || 3000;

// Database Sync
const syncDatabase = async () => {
    let retries = 30;
    while (retries) {
        try {
            <% if (database === 'MongoDB') { %>
            const connectDB = require('./infrastructure/database/database');
            await connectDB();
            <% } else { %>
            const sequelize = require('./infrastructure/database/database');
            await sequelize.sync();
            <% } %>
            logger.info('Database synced');
            // Start the web server after DB sync
            startServer(PORT);
            <% if (communication === 'Kafka') { %>
            // Connect Kafka
            connectKafka().then(async () => {
              logger.info('Kafka connected');
              await sendMessage('test-topic', 'Hello Kafka from Clean Arch JS!');
            }).catch(err => {
              logger.error('Failed to connect to Kafka:', err);
            });
            <% } -%>
            break;
        } catch (error) {
            logger.error('Error syncing database:', error);
            retries -= 1;
            logger.info(`Retries left: ${retries}`);
            await new Promise(res => setTimeout(res, 5000));
        }
    }
};
syncDatabase();