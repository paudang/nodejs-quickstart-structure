const redis = require('../infrastructure/caching/redisClient');
const logger = require('../infrastructure/log/logger');

class GetAllUsers {
    constructor(userRepository) {
        this.userRepository = userRepository;
    }

    async execute() {
        const cacheKey = 'users:all';
        try {
            const cachedUsers = await redis.get(cacheKey);
            if (cachedUsers) {
                logger.info('Serving users from cache');
                return JSON.parse(cachedUsers);
            }
        } catch (error) {
            logger.error('Redis error (get):', error);
        }

        const users = await this.userRepository.getUsers();

        try {
            await redis.set(cacheKey, JSON.stringify(users), 'EX', 60);
        } catch (error) {
            logger.error('Redis error (set):', error);
        }

        return users;
    }
}

module.exports = GetAllUsers;
