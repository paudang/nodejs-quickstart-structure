import { kafka } from '<%= configPath %>';
import { EachMessagePayload, Producer, Consumer } from 'kafkajs';
import logger from '<%= loggerPath %>';

export class KafkaService {
    private producer: Producer;
    private consumer: Consumer;

    constructor() {
        this.producer = kafka.producer();
        this.consumer = kafka.consumer({ groupId: 'test-group' });
    }

    async connect() {
        await this.producer.connect();
        await this.consumer.connect();
        await this.consumer.subscribe({ topic: 'test-topic', fromBeginning: true });

        await this.consumer.run({
            eachMessage: async ({ topic, partition, message }: EachMessagePayload) => {
                logger.info({
                    value: message.value?.toString(),
                });
            },
        });
    }

    async sendMessage(topic: string, message: string) {
        await this.producer.send({
            topic,
            messages: [
                { value: message },
            ],
        });
    }
}

